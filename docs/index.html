<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bonnie-engine :: PS1 Software Rasterizer</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            outline: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #eee;
            font-family: monospace;
            font-size: 18px;
            z-index: 10;
            text-align: center;
        }
        #loading-bar-container {
            width: 300px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 16px;
            overflow: hidden;
        }
        #loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00bfe6, #00d4ff);
            border-radius: 4px;
            transition: width 0.1s ease-out;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>Loading Bonnie Engine...</div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-status" style="margin-top: 8px; font-size: 14px; color: #888;"></div>
    </div>
    <canvas id="glcanvas" tabindex="1"></canvas>
    <script src="mq_js_bundle.js"></script>
    <script>
        document.getElementById('glcanvas').addEventListener('contextmenu', e => e.preventDefault());

        // Bonnie engine file import/export functions
        // These use native browser localStorage directly

        // Import: open file picker and store result in localStorage for Rust to read
        window.bonnie_import_file = function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.ron';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        localStorage.setItem('_bonnie_import_data', e.target.result);
                        localStorage.setItem('_bonnie_import_filename', file.name);
                        localStorage.setItem('_bonnie_import_ready', 'true');
                        console.log('Import: file loaded into localStorage:', file.name);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        // Download: check localStorage for export data and trigger download
        // Called from Rust after writing data to localStorage
        window.bonnie_trigger_download = function() {
            var data = localStorage.getItem('_bonnie_export_data');
            var filename = localStorage.getItem('_bonnie_export_filename') || 'level.ron';
            console.log('bonnie_trigger_download called, data length:', data ? data.length : 0, 'filename:', filename);

            if (data) {
                var blob = new Blob([data], {type: 'text/plain'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Clear the export data
                localStorage.removeItem('_bonnie_export_data');
                localStorage.removeItem('_bonnie_export_filename');
            }
        };

        // Set export data in localStorage (called from Rust via quad-storage or direct)
        window.bonnie_set_export_data = function(ptr, len) {
            // Read string from WASM memory
            var bytes = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
            var data = new TextDecoder().decode(bytes);
            localStorage.setItem('_bonnie_export_data', data);
            console.log('bonnie_set_export_data: stored', len, 'bytes');
        };

        // Set export filename in localStorage
        window.bonnie_set_export_filename = function(ptr, len) {
            var bytes = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
            var filename = new TextDecoder().decode(bytes);
            localStorage.setItem('_bonnie_export_filename', filename);
            console.log('bonnie_set_export_filename:', filename);
        };

        // Check if import is ready
        // Returns 1 if import ready, 0 if not
        window.bonnie_check_import = function() {
            var ready = localStorage.getItem('_bonnie_import_ready');
            return ready === 'true' ? 1 : 0;
        };

        // Get the length of imported data (for buffer allocation)
        window.bonnie_get_import_data_len = function() {
            var data = localStorage.getItem('_bonnie_import_data') || '';
            return data.length;
        };

        // Get the length of imported filename (for buffer allocation)
        window.bonnie_get_import_filename_len = function() {
            var filename = localStorage.getItem('_bonnie_import_filename') || '';
            return filename.length;
        };

        // Copy imported data to WASM memory buffer
        window.bonnie_copy_import_data = function(ptr, max_len) {
            var data = localStorage.getItem('_bonnie_import_data') || '';
            var len = Math.min(data.length, max_len);
            var bytes = new TextEncoder().encode(data);
            var dest = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
            dest.set(bytes.subarray(0, len));
            return len;
        };

        // Copy imported filename to WASM memory buffer
        window.bonnie_copy_import_filename = function(ptr, max_len) {
            var filename = localStorage.getItem('_bonnie_import_filename') || '';
            var len = Math.min(filename.length, max_len);
            var bytes = new TextEncoder().encode(filename);
            var dest = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
            dest.set(bytes.subarray(0, len));
            return len;
        };

        // Clear the import data (call after successfully reading)
        window.bonnie_clear_import = function() {
            localStorage.removeItem('_bonnie_import_ready');
            localStorage.removeItem('_bonnie_import_data');
            localStorage.removeItem('_bonnie_import_filename');
            console.log('bonnie_clear_import: cleared import data');
        };

        // Loading progress functions
        window.bonnie_set_loading_progress = function(current, total) {
            var percent = total > 0 ? (current / total) * 100 : 0;
            var bar = document.getElementById('loading-bar');
            if (bar) bar.style.width = percent + '%';
        };

        window.bonnie_set_loading_status = function(ptr, len) {
            var bytes = new Uint8Array(wasm_exports.memory.buffer, ptr, len);
            var status = new TextDecoder().decode(bytes);
            var el = document.getElementById('loading-status');
            if (el) el.textContent = status;
        };

        window.bonnie_hide_loading = function() {
            var el = document.getElementById('loading');
            if (el) el.style.display = 'none';
        };

        // Texture prefetch cache - JavaScript fetches in parallel, WASM reads from cache
        window.bonnie_texture_cache = {};
        window.bonnie_prefetch_complete = false;
        window.bonnie_prefetch_total = 0;
        window.bonnie_prefetch_loaded = 0;

        // Check if prefetch is complete
        window.bonnie_is_prefetch_complete = function() {
            return window.bonnie_prefetch_complete ? 1 : 0;
        };

        // Get cached texture dimensions (returns width << 16 | height, or 0 if not found)
        window.bonnie_get_cached_texture_info = function(ptr, path_len) {
            var bytes = new Uint8Array(wasm_exports.memory.buffer, ptr, path_len);
            var path = new TextDecoder().decode(bytes);
            var tex = window.bonnie_texture_cache[path];
            if (!tex) return 0;
            // Pack width and height into a single u32: high 16 bits = width, low 16 bits = height
            return (tex.width << 16) | tex.height;
        };

        // Copy cached texture RGBA data to WASM memory
        window.bonnie_copy_cached_texture = function(path_ptr, path_len, dest_ptr, max_len) {
            var pathBytes = new Uint8Array(wasm_exports.memory.buffer, path_ptr, path_len);
            var path = new TextDecoder().decode(pathBytes);
            var tex = window.bonnie_texture_cache[path];
            if (!tex || !tex.data) return 0;
            var len = Math.min(tex.data.length, max_len);
            var dest = new Uint8Array(wasm_exports.memory.buffer, dest_ptr, len);
            dest.set(tex.data.subarray(0, len));
            return len;
        };

        // Decode PNG to raw RGBA using browser's native decoder (much faster than WASM)
        function decodePngToRgba(blob) {
            return new Promise(function(resolve, reject) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    var imageData = ctx.getImageData(0, 0, img.width, img.height);
                    // Return width, height, and raw RGBA data
                    resolve({
                        width: img.width,
                        height: img.height,
                        data: imageData.data // Uint8ClampedArray of RGBA
                    });
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = function() {
                    URL.revokeObjectURL(img.src);
                    reject(new Error('Failed to decode image'));
                };
                img.src = URL.createObjectURL(blob);
            });
        }

        // Prefetch and decode all textures in parallel before WASM starts
        async function prefetchTextures() {
            var statusEl = document.getElementById('loading-status');
            var barEl = document.getElementById('loading-bar');

            if (statusEl) statusEl.textContent = 'Loading manifest...';

            try {
                var manifestResponse = await fetch('assets/textures/manifest.txt');
                var manifest = await manifestResponse.text();

                // Parse manifest to get all texture paths
                var texturePaths = [];
                var currentPack = null;
                manifest.split('\n').forEach(function(line) {
                    line = line.trim();
                    if (!line) return;
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentPack = line.slice(1, -1);
                    } else if (currentPack) {
                        texturePaths.push('assets/textures/' + currentPack + '/' + line);
                    }
                });

                window.bonnie_prefetch_total = texturePaths.length;
                if (statusEl) statusEl.textContent = 'Loading ' + texturePaths.length + ' textures...';

                // Fetch AND decode all textures in parallel using browser's native PNG decoder
                var fetchPromises = texturePaths.map(function(path) {
                    return fetch(path)
                        .then(function(response) {
                            if (!response.ok) throw new Error('HTTP ' + response.status);
                            return response.blob();
                        })
                        .then(function(blob) {
                            return decodePngToRgba(blob);
                        })
                        .then(function(decoded) {
                            // Store decoded RGBA data (no PNG decoding needed in WASM!)
                            window.bonnie_texture_cache[path] = decoded;
                            window.bonnie_prefetch_loaded++;
                            var percent = (window.bonnie_prefetch_loaded / window.bonnie_prefetch_total) * 100;
                            if (barEl) barEl.style.width = percent + '%';
                        })
                        .catch(function(err) {
                            console.warn('Failed to load:', path, err);
                            window.bonnie_prefetch_loaded++;
                        });
                });

                await Promise.all(fetchPromises);
                window.bonnie_prefetch_complete = true;
                if (statusEl) statusEl.textContent = 'Starting engine...';
                console.log('Loaded and decoded', Object.keys(window.bonnie_texture_cache).length, 'textures');

            } catch (err) {
                console.error('Prefetch failed:', err);
                window.bonnie_prefetch_complete = true; // Continue anyway, WASM will fallback
            }
        }

        // Register as WASM imports so Rust can call them
        miniquad_add_plugin({
            register_plugin: function(importObject) {
                importObject.env.bonnie_import_file = window.bonnie_import_file;
                importObject.env.bonnie_check_import = window.bonnie_check_import;
                importObject.env.bonnie_get_import_data_len = window.bonnie_get_import_data_len;
                importObject.env.bonnie_get_import_filename_len = window.bonnie_get_import_filename_len;
                importObject.env.bonnie_copy_import_data = window.bonnie_copy_import_data;
                importObject.env.bonnie_copy_import_filename = window.bonnie_copy_import_filename;
                importObject.env.bonnie_clear_import = window.bonnie_clear_import;
                importObject.env.bonnie_set_export_data = window.bonnie_set_export_data;
                importObject.env.bonnie_set_export_filename = window.bonnie_set_export_filename;
                importObject.env.bonnie_trigger_download = window.bonnie_trigger_download;
                importObject.env.bonnie_set_loading_progress = window.bonnie_set_loading_progress;
                importObject.env.bonnie_set_loading_status = window.bonnie_set_loading_status;
                importObject.env.bonnie_hide_loading = window.bonnie_hide_loading;
                importObject.env.bonnie_is_prefetch_complete = window.bonnie_is_prefetch_complete;
                importObject.env.bonnie_get_cached_texture_info = window.bonnie_get_cached_texture_info;
                importObject.env.bonnie_copy_cached_texture = window.bonnie_copy_cached_texture;
            }
        });

        // Prefetch textures first, then load WASM
        prefetchTextures().then(function() {
            load("bonnie-rs.wasm");
        });
    </script>
</body>
</html>
